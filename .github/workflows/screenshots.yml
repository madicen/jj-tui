name: Generate Screenshots

on:
  # Called by release workflows after publishing
  workflow_call:
  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write

jobs:
  screenshots:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Need full history for commits
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install jj
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          JJ_VERSION=$(gh api repos/martinvonz/jj/releases/latest --jq '.tag_name')
          echo "Installing jj version: ${JJ_VERSION}"
          curl -LsSf "https://github.com/martinvonz/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/jj.tar.gz
          sudo tar xzf /tmp/jj.tar.gz -C /usr/local/bin --strip-components=1 ./jj
          rm /tmp/jj.tar.gz
          jj --version

      - name: Configure git for jj
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Build jj-tui
        run: go build -o jj-tui .

      - name: Setup demo repository
        run: ./fixtures/setup-demo-repo.sh

      # Install VHS and dependencies manually (VHS action has issues with ffmpeg)
      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd
          # Install VHS from releases
          VHS_VERSION=$(curl -s https://api.github.com/repos/charmbracelet/vhs/releases/latest | jq -r '.tag_name')
          curl -LsSf "https://github.com/charmbracelet/vhs/releases/download/${VHS_VERSION}/vhs_${VHS_VERSION#v}_Linux_x86_64.tar.gz" -o /tmp/vhs.tar.gz
          # Extract to temp dir and find the binary
          mkdir -p /tmp/vhs-extract
          tar xzf /tmp/vhs.tar.gz -C /tmp/vhs-extract
          echo "Contents of extracted archive:"
          find /tmp/vhs-extract -type f
          # Find and move the vhs binary
          sudo mv $(find /tmp/vhs-extract -name 'vhs' -type f | head -1) /usr/local/bin/
          rm -rf /tmp/vhs.tar.gz /tmp/vhs-extract
          vhs --version

      # Generate screenshots using VHS directly
      - name: Generate screenshots
        run: |
          vhs vhs/graph.tape
          vhs vhs/prs.tape
          vhs vhs/tickets.tape
          vhs vhs/branches.tape
          vhs vhs/settings.tape
          vhs vhs/help.tape
          vhs vhs/all.tape

      - name: List generated files
        run: ls -la screenshots/

      # Upload as artifacts (do this first so we get artifacts even if commit fails)
      - name: Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/
          retention-days: 7

      # Commit screenshots back to repo
      - name: Commit updated screenshots
        run: |
          # Check if any screenshots were actually generated/changed
          if git diff --quiet screenshots/ && git diff --cached --quiet screenshots/; then
            echo "No changes to screenshots"
            exit 0
          fi
          
          # Stash the generated screenshots before switching branches
          git stash push -m "screenshots" -- screenshots/
          
          # Switch to main branch (releases run on tags)
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          
          # Restore the screenshots
          git stash pop
          
          # Stage and commit
          git add screenshots/
          if git diff --staged --quiet; then
            echo "No changes to commit after restoring screenshots"
            exit 0
          fi
          
          git commit -m "chore: update screenshots [skip ci]"
          
          # Push with retry logic in case of concurrent updates
          for i in 1 2 3; do
            if git push origin main; then
              echo "Successfully pushed screenshots"
              exit 0
            fi
            echo "Push failed, attempt $i of 3. Pulling and retrying..."
            git pull --rebase origin main
          done
          
          echo "Failed to push after 3 attempts"
          exit 1

