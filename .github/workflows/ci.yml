name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install jj (for integration tests)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Download latest jj release using gh CLI (authenticated, avoids rate limits)
          JJ_VERSION=$(gh api repos/martinvonz/jj/releases/latest --jq '.tag_name')
          if [ -z "$JJ_VERSION" ] || [ "$JJ_VERSION" = "null" ]; then
            echo "Failed to get jj version from GitHub API"
            exit 1
          fi
          echo "Installing jj version: ${JJ_VERSION}"
          # Download and extract jj binary (archive contains ./jj with ./ prefix)
          curl -LsSf "https://github.com/martinvonz/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/jj.tar.gz
          sudo tar xzf /tmp/jj.tar.gz -C /usr/local/bin --strip-components=1 ./jj
          rm /tmp/jj.tar.gz
          jj --version

      - name: Build
        run: |
          # Inject version info (short commit SHA for dev builds)
          VERSION="dev-${GITHUB_SHA::7}"
          go build -v -ldflags "-X github.com/madicen/jj-tui/internal/version.Version=${VERSION}" ./...

      - name: Run unit tests
        run: go test -v ./internal/tui/... ./internal/config/... ./internal/codecks/...

      - name: Run integration tests
        run: |
          # Configure git for jj
          git config --global user.name "CI Test"
          git config --global user.email "ci@test.com"
          go test -v ./integration_tests/...

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

