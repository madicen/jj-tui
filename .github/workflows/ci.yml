name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install jj (for integration tests)
        run: |
          # Download latest jj release using jq for reliable JSON parsing
          JJ_VERSION=$(curl -s https://api.github.com/repos/martinvonz/jj/releases/latest | jq -r '.tag_name')
          echo "Installing jj version: ${JJ_VERSION}"
          # The tarball contains jj binary directly (no subdirectory)
          curl -LsSf "https://github.com/martinvonz/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/jj.tar.gz
          sudo tar xzf /tmp/jj.tar.gz -C /usr/local/bin jj
          jj --version

      - name: Build
        run: go build -v ./...

      - name: Run unit tests
        run: go test -v ./internal/tui/... ./internal/config/... ./internal/codecks/...

      - name: Run integration tests
        run: |
          # Configure git for jj
          git config --global user.name "CI Test"
          git config --global user.email "ci@test.com"
          go test -v ./integration_tests/...

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

